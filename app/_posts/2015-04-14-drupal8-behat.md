---
title: Behat for Drupal 8
tags:
  - Behat
  - Drupal 8
  - "Drupal-planet"
permalink: "/content/drupal-8-Behat"
author: RoySegall
layout: post
published: true
---

{% include setup %}
The first time i heard about Behat was at DrupalCon Munich 2012. Since then the usage of Behat has grown exponential and the tools it can be integrate with has grown as well - we can test the markup of a page. Pretty amazing, no? Well, It’s time to take it a little bit higher but in another direction. But first, let’s see how it’s actually works.

Behat built from several symfony components:

  - Cucumber steps - AKA feature files(*.feature). Contains the scenarios.
  - Scenario - Collection of steps written in plain english, or any other 
    language, combining together a test.
  - Step definition - A method with PHP code. Behat will found the matching 
    method to a step definition according to the attached annotation.
  - Gherkin - Deconstructs the feature file into a PHP object.
  - Beheat - The key component - Search for methods matching the step definition 
    and invoke the method.
  - Mink - Behat default browser.

The basic idea is that the feature files are teared down to small sentence, 
Behat looks for method with matching annotation and invoke it. Mink give us the 
browser functionality such as forms, DOM validation and more.

<!-- more -->

## What next?

After understanding how Behat works - why not implement it into Drupal? The 
common implementation for Behat is the Behat Drupal Extension, maintained by 
Jonathan Hedstrom, which provide integration layer between Behat and Drupal.

The next step will be using Behat as a built in solution for contribute 
components(modules and themes). Yes, in addition to simple test and PHP unit 
testing, which added in Drupal 8, components could write tests in cucumber steps.

## How?

In order to make it work, i was needed to break down Behat workflow into Drupal 
8 using the available tools. Let’s dive in!

## Step definition

The step definition mechanism find the method he need to invoke by the 
annotation on the method. In order to get the same functionality i created a 
new plugin in Drupal 8. Let’s take for example the basic step definition 
‘I visit “user”’ which take us to the the user page. The plugin definition look 
like:

```php
<?php
  /**
   * @Step(
   *  id = "I visit '(.*?)'"
   * )
   */
```

Inside the class you’ll implement a method called Step and look like this:

```php
<?php
  public function step(BehatTestsAbstract $Behat, $url) {
    // Logic implementation.
  }
```
Each place holder, (.*?), will be passed as additional argument. The $Behat 
object is an instance of BehatTestsAbstract which allow us to invoke the methods 
of the simpletest class.

## Feature file

The feature file is the heart of this initiative. In order to be able to parse i 
need the Behat/Gherkin extension. Getting it via composer is easy, Very easy:

```json
{
  "require": {
    "Behat/gherkin": "~4.3"
  },
  "config": {
    "vendor-dir": "src/Behat"
  }
}
```

But how i can add it to Drupal 8 autoloader? I looked for several blog posts but
 non of them gave me the answer. The solution is very simple. Inside the module 
 i file i included the autoloader generated by composer:

```php
<?php
	require_once 'src/Behat/autoload.php';
```

The feature files should be located under src/features. But the main problem is 
how can we pass information from the test, such as a created user with random 
name and password? The solution is simple - arguments:

```cucumber
  Scenario: Testing the login form.
     Given I visit 'user'
       And I fill in 'Username' with '@user-name'
       And I fill in 'Password' with '@user-pass'
      When I press 'Log in'
      Then I should see '@user-name'
```

In the example above we can run the test with unknown user name. How to pass the
 username to the feature? You can read about it in the next paragraph. 

## Running a test

OK. We know how Behat works, how to define a test and where we need to place the
feature files. But how can we run it? Let’s see how the login tests work. First
we need to create a user:
	
```php
<?php
  	$account = $this->drupalCreateUser();
```

Now we need to pass the name and password to the feature:

```php
<?php
    $this
      ->setPlaceholder('@user-name', $account->label())
      ->setPlaceholder('@user-pass', $account->passRaw)
```

Pretty simple. Each feature file could contain a bunch of scenario and we might 
want to run tests with tags. This is how:

```php
<?php
	$this->setTag('@login-success');
```

This will make sure only scenarios with the @login-success tag will run. We need
 to point Drupal to the location of the file:

```php
<?php
	$this->executeScenario('login', 'Behat');
```

The first argument will be the name of the file. In our case is login.feature 
but we don’t need to add the feature extension, this would be pretty redundant. 
Behat will add it for you. The second argument is the module. This is how we 
know which module contains the feature files. What if a theme would like to use 
Behat as testing tool?

```php
<?php
	$this->executeScenario('carousel', 'boostrap', 'theme');
```

This will work if Bootstrap will have a Behat test for the carousel. And now, 
the full code:

```php
<?php
  public function testLogin() {
    $account = $this->drupalCreateUser();
    $this
      ->setPlaceholder('@user-name', $account->label())
      ->setPlaceholder('@user-pass', $account->passRaw)
      ->setTag('@login-success')
      ->executeScenario('login', 'Behat');
  }
```

A good QA would validate also failures of the login process:

```cucumber
  @login-failed
  Scenario: Testing the user can't login with bas credentials.
    Given I visit 'user'
      And I fill in 'Username' with 'foo'
      And I fill in 'Password' with 'bar'
     When I press 'Log in'
     Then I should see 'Sorry, unrecognized username or password.'
```

Since the login test dosent required any argument the test method would be a 
lot more simple:
  
```php
<?php
  public function testLoginFailed() {
    $this->setTag('@login-failed')->executeScenario('login', 'Behat');
  }
```

The module available on [github](https://github.com/roysegall/Behat) and ready 
for feedbacks and pull requests.
